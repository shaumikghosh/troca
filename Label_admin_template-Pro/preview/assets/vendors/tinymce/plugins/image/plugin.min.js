!function(){"use strict";var i,e=tinymce.util.Tools.resolve("tinymce.PluginManager"),d=function(e){return!1!==e.settings.image_dimensions},m=function(e){return!0===e.settings.image_advtab},a=function(e){return e.getParam("image_class_list")},g=function(e){return e.getParam("images_upload_url",!1)},f=function(e){return e.getParam("images_upload_handler",!1)},r="undefined"!=typeof window?window:Function("return this;")(),v=function(e,t){var n,a=(n=t,function(e,t){for(var n=null!=t?t:r,a=0;a<e.length&&null!=n;++a)n=n[e[a]];return n}(e.split("."),n));if(null==a)throw e+" not available on this browser";return a},b=tinymce.util.Tools.resolve("tinymce.util.Promise"),y=tinymce.util.Tools.resolve("tinymce.util.Tools"),o=tinymce.util.Tools.resolve("tinymce.util.XHR"),p=function(e,t){return Math.max(parseInt(e,10),parseInt(t,10))},h=function(e,r,t){return function n(e,a){return a=a||[],y.each(e,function(e){var t={text:e.text||e.title};e.menu?t.menu=n(e.menu):(t.value=e.value,r(t)),a.push(t)}),a}(e,t||[])},x=function(e){return e&&(e=e.replace(/px$/,"")),e},l=function(e){return 0<e.length&&/^[0-9]+$/.test(e)&&(e+="px"),e},w=function(e){if(e.margin){var t=e.margin.split(" ");switch(t.length){case 1:e["margin-top"]=e["margin-top"]||t[0],e["margin-right"]=e["margin-right"]||t[0],e["margin-bottom"]=e["margin-bottom"]||t[0],e["margin-left"]=e["margin-left"]||t[0];break;case 2:e["margin-top"]=e["margin-top"]||t[0],e["margin-right"]=e["margin-right"]||t[1],e["margin-bottom"]=e["margin-bottom"]||t[0],e["margin-left"]=e["margin-left"]||t[1];break;case 3:e["margin-top"]=e["margin-top"]||t[0],e["margin-right"]=e["margin-right"]||t[1],e["margin-bottom"]=e["margin-bottom"]||t[2],e["margin-left"]=e["margin-left"]||t[1];break;case 4:e["margin-top"]=e["margin-top"]||t[0],e["margin-right"]=e["margin-right"]||t[1],e["margin-bottom"]=e["margin-bottom"]||t[2],e["margin-left"]=e["margin-left"]||t[3]}delete e.margin}return e},t=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),c=Object.prototype.hasOwnProperty,s=(i=function(e,t){return t},function(){for(var e=new Array(arguments.length),t=0;t<e.length;t++)e[t]=arguments[t];if(0===e.length)throw new Error("Can't merge zero objects");for(var n={},a=0;a<e.length;a++){var r=e[a];for(var o in r)c.call(r,o)&&(n[o]=i(n[o],r[o]))}return n}),u=t.DOM,C=function(e){return e.style.marginLeft&&e.style.marginRight&&e.style.marginLeft===e.style.marginRight?x(e.style.marginLeft):""},S=function(e){return e.style.marginTop&&e.style.marginBottom&&e.style.marginTop===e.style.marginBottom?x(e.style.marginTop):""},N=function(e){return e.style.borderWidth?x(e.style.borderWidth):""},n=function(e,t){return e.hasAttribute(t)?e.getAttribute(t):""},_=function(e,t){return e.style[t]?e.style[t]:""},T=function(e){return null!==e.parentNode&&"FIGURE"===e.parentNode.nodeName},A=function(e,t,n){e.setAttribute(t,n)},R=function(e,t){var n=e.getAttribute("style"),a=t(null!==n?n:"");0<a.length?(e.setAttribute("style",a),e.setAttribute("data-mce-style",a)):e.removeAttribute("style")},I=function(e,a){return function(e,t,n){e.style[t]?(e.style[t]=l(n),R(e,a)):A(e,t,n)}},L=function(e,t){return e.style[t]?x(e.style[t]):n(e,t)},P=function(e,t){var n=l(t);e.style.marginLeft=n,e.style.marginRight=n},U=function(e,t){var n=l(t);e.style.marginTop=n,e.style.marginBottom=n},O=function(e,t){var n=l(t);e.style.borderWidth=n},E=function(e,t){e.style.borderStyle=t},k=function(e){return"FIGURE"===e.nodeName},M=function(e,t){return{src:n(t,"src"),alt:n(t,"alt"),title:n(t,"title"),width:L(t,"width"),height:L(t,"height"),class:n(t,"class"),style:e(n(t,"style")),caption:T(t),hspace:C(t),vspace:S(t),border:N(t),borderStyle:_(t,"borderStyle")}},z=function(e,t,n,a,r){n[a]!==t[a]&&r(e,a,n[a])},B=function(a,r){return function(e,t,n){a(e,n),R(e,r)}},H=function(e,t,n){var a=M(e,n);z(n,a,t,"caption",function(e,t,n){var a,r,o,i,l;T(a=e)?(l=(i=a).parentNode,u.insertAfter(i,l),u.remove(l)):(r=a,o=u.create("figure",{class:"image"}),u.insertAfter(o,r),o.appendChild(r),o.appendChild(u.create("figcaption",{contentEditable:!0},"Caption")),o.contentEditable="false")}),z(n,a,t,"src",A),z(n,a,t,"alt",A),z(n,a,t,"title",A),z(n,a,t,"width",I(0,e)),z(n,a,t,"height",I(0,e)),z(n,a,t,"class",A),z(n,a,t,"style",B(function(e,t){return A(e,"style",t)},e)),z(n,a,t,"hspace",B(P,e)),z(n,a,t,"vspace",B(U,e)),z(n,a,t,"border",B(O,e)),z(n,a,t,"borderStyle",B(E,e))},j=function(e,t){var n=e.dom.styles.parse(t),a=w(n),r=e.dom.styles.parse(e.dom.styles.serialize(a));return e.dom.styles.serialize(r)},D=function(e){var t=e.selection.getNode(),n=e.dom.getParent(t,"figure.image");return n?e.dom.select("img",n)[0]:t&&("IMG"!==t.nodeName||t.getAttribute("data-mce-object")||t.getAttribute("data-mce-placeholder"))?null:t},F=function(t,e){var n=t.dom,a=n.getParent(e.parentNode,function(e){return t.schema.getTextBlockElements()[e.nodeName]},t.getBody());return a?n.split(a,e):e},W=function(t){var e=D(t);return e?M(function(e){return j(t,e)},e):{src:"",alt:"",title:"",width:"",height:"",class:"",style:"",caption:!1,hspace:"",vspace:"",border:"",borderStyle:""}},J=function(r,e){var t=function(e,t){var n=document.createElement("img");if(H(function(e){return j(r,e)},s(t,{caption:!1}),n),A(n,"alt",t.alt),t.caption){var a=u.create("figure",{class:"image"});return a.appendChild(n),a.appendChild(u.create("figcaption",{contentEditable:!0},"Caption")),a.contentEditable="false",a}return n}(0,e);r.dom.setAttrib(t,"data-mce-id","__mcenew"),r.focus(),r.selection.setContent(t.outerHTML);var n=r.dom.select('*[data-mce-id="__mcenew"]')[0];if(r.dom.setAttrib(n,"data-mce-id",null),k(n)){var a=F(r,n);r.selection.select(a)}else r.selection.select(n)},V=function(e,t){var n=D(e);n?t.src?function(t,e){var n,a=D(t);if(H(function(e){return j(t,e)},e,a),n=a,t.dom.setAttrib(n,"src",n.getAttribute("src")),k(a.parentNode)){var r=a.parentNode;F(t,r),t.selection.select(a.parentNode)}else t.selection.select(a),function(e,t,n){function a(){n.onload=n.onerror=null,e.selection&&(e.selection.select(n),e.nodeChanged())}n.onload=function(){t.width||t.height||!d(e)||e.dom.setAttribs(n,{width:n.clientWidth,height:n.clientHeight}),a()},n.onerror=a}(t,e,a)}(e,t):function(e,t){if(t){var n=e.dom.is(t.parentNode,"figure.image")?t.parentNode:t;e.dom.remove(n),e.focus(),e.nodeChanged(),e.dom.isEmpty(e.getBody())&&(e.setContent(""),e.selection.setCursorLocation())}}(e,n):t.src&&J(e,t)},G=function(o,i){i.find("#style").each(function(e){var t,n,a,r=(n=s({src:"",alt:"",title:"",width:"",height:"",class:"",style:"",caption:!(t=function(e){return j(o,e)}),hspace:"",vspace:"",border:"",borderStyle:""},i.toJSON()),a=document.createElement("img"),A(a,"style",n.style),(C(a)||""!==n.hspace)&&P(a,n.hspace),(S(a)||""!==n.vspace)&&U(a,n.vspace),(N(a)||""!==n.border)&&O(a,n.border),(_(a,"borderStyle")||""!==n.borderStyle)&&E(a,n.borderStyle),t(a.getAttribute("style")));e.value(r)})},$=function(e,t){e.state.set("oldVal",e.value()),t.state.set("oldVal",t.value())},X=function(e,t){var n=e.find("#width")[0],a=e.find("#height")[0],r=e.find("#constrain")[0];n&&a&&r&&t(n,a,r.checked())},q=function(e,t,n){var a=e.state.get("oldVal"),r=t.state.get("oldVal"),o=e.value(),i=t.value();n&&a&&r&&o&&i&&(o!==a?(i=Math.round(o/a*i),isNaN(i)||t.value(i)):(o=Math.round(i/r*o),isNaN(o)||e.value(o))),$(e,t)},K=function(e){X(e,q)},Q=function(e){X(e,$)},Y=K,Z=function(e){e.meta=e.control.rootControl.toJSON()},ee=function(u,e){var t,n=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:!0,onchange:function(e){var t,n,a,r,o,i,l,c,s;n=u,i=(t=e).meta||{},l=t.control,(s=(c=l.rootControl).find("#image-list")[0])&&s.value(n.convertURL(l.value(),"src")),y.each(i,function(e,t){c.find("#"+t).value(e)}),i.width||i.height||(a=n.convertURL(l.value(),"src"),r=n.getParam("image_prepend_url",""),o=new RegExp("^(?:[a-z]+:)?//","i"),r&&!o.test(a)&&a.substring(0,r.length)!==r&&(a=r+a),l.value(a),function(e,n){var a=document.createElement("img");function t(e,t){a.parentNode&&a.parentNode.removeChild(a),n({width:e,height:t})}a.onload=function(){t(p(a.width,a.clientWidth),p(a.height,a.clientHeight))},a.onerror=function(){t(0,0)};var r=a.style;r.visibility="hidden",r.position="fixed",r.bottom=r.left="0px",r.width=r.height="auto",document.body.appendChild(a),a.src=e}(n.documentBaseURI.toAbsolute(l.value()),function(e){e.width&&e.height&&d(n)&&(c.find("#width").value(e.width),c.find("#height").value(e.height),Q(c))}))},onbeforecall:Z},e];return!1!==u.settings.image_description&&n.push({name:"alt",type:"textbox",label:"Image description"}),!0===u.settings.image_title&&n.push({name:"title",type:"textbox",label:"Image Title"}),d(u)&&n.push({type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:5,onchange:t=function(e){K(e.control.rootControl)},ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:5,onchange:t,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),a(u)&&n.push({name:"class",type:"listbox",label:"Class",values:h(a(u),function(e){e.value&&(e.textStyle=function(){return u.formatter.getCssText({inline:"img",classes:[e.value]})})})}),!0===u.settings.image_caption&&n.push({name:"caption",type:"checkbox",label:"Caption"}),n},te=ee,ne=function(){return v("URL")},ae=tinymce.util.Tools.resolve("tinymce.ui.Factory"),re=function(){};var oe=function(h){return function(e){var i,t,n,a,r,o,l,c,s=ae.get("Throbber"),u=e.control.rootControl,d=new s(u.getEl()),m=e.control.value(),g=(l=m,ne().createObjectURL(l)),f=(i={url:(o=h,o.getParam("images_upload_url")),basePath:(r=h,r.getParam("images_upload_base_path")),credentials:(a=h,a.getParam("images_upload_credentials")),handler:(n=h,n.getParam("images_upload_handler"))},t=function(e,a,r,t){var o,n;(o=new(v("XMLHttpRequest"))).open("POST",i.url),o.withCredentials=i.credentials,o.upload.onprogress=function(e){t(e.loaded/e.total*100)},o.onerror=function(){r("Image upload failed due to a XHR Transport error. Code: "+o.status)},o.onload=function(){var e,t,n;o.status<200||300<=o.status?r("HTTP Error: "+o.status):(e=JSON.parse(o.responseText))&&"string"==typeof e.location?a((t=i.basePath,n=e.location,t?t.replace(/\/$/,"")+"/"+n.replace(/^\//,""):n)):r("Invalid JSON: "+o.responseText)},(n=new FormData).append("file",e.blob(),e.filename()),o.send(n)},i=y.extend({credentials:!1,handler:t},i),{upload:function(e){return i.url||i.handler!==t?(n=e,a=i.handler,new b(function(e,t){try{a(n,e,t,re)}catch(e){t(e.message)}})):b.reject("Upload url missing from the settings.");var n,a}}),p=function(){var e;d.hide(),e=g,ne().revokeObjectURL(e)};return d.show(),(c=m,new b(function(e,t){var n=new(v("FileReader"));n.onload=function(){e(n.result)},n.onerror=function(){t(n.error.message)},n.readAsDataURL(c)})).then(function(e){var t=h.editorUpload.blobCache.create({blob:m,blobUri:g,name:m.name?m.name.replace(/\.[^\.]+$/,""):null,base64:e.split(",")[1]});return f.upload(t).then(function(e){var t=u.find("#src");return t.value(e),u.find("tabpanel")[0].activateTab(0),t.fire("change"),p(),e})}).catch(function(e){h.windowManager.alert(e),p()})}},ie=".jpg,.jpeg,.png,.gif";function le(a){for(var r=[],e=1;e<arguments.length;e++)r[e-1]=arguments[e];return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=r.concat(e);return a.apply(null,n)}}var ce=function(t,e){var n=e.control.getRoot();Y(n),t.undoManager.transact(function(){var e=s(W(t),n.toJSON());V(t,e)}),t.editorUpload.uploadImagesAuto()};function se(u){function n(e){var n,t,a,r,o,i,l,c=W(u);if(e&&(t={type:"listbox",label:"Image list",name:"image-list",values:h(e,function(e){e.value=u.convertURL(e.value||e.url,"src")},[{text:"None",value:""}]),value:c.src&&u.convertURL(c.src,"src"),onselect:function(e){var t=n.find("#alt");(!t.value()||e.lastControl&&t.value()===e.lastControl.text())&&t.value(e.control.text()),n.find("#src").value(e.control.value()).fire("change")},onPostRender:function(){t=this}}),m(u)||g(u)||f(u)){var s=[(i=u,l=t,{title:"General",type:"form",items:ee(i,l)})];m(u)&&s.push({title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox",onchange:(o=r=u,function(e){var t=o.dom,n=e.control.rootControl;if(m(o)){var a=n.toJSON(),r=t.parseStyle(a.style);n.find("#vspace").value(""),n.find("#hspace").value(""),((r=w(r))["margin-top"]&&r["margin-bottom"]||r["margin-right"]&&r["margin-left"])&&(r["margin-top"]===r["margin-bottom"]?n.find("#vspace").value(x(r["margin-top"])):n.find("#vspace").value(""),r["margin-right"]===r["margin-left"]?n.find("#hspace").value(x(r["margin-right"])):n.find("#hspace").value("")),r["border-width"]?n.find("#border").value(x(r["border-width"])):n.find("#border").value(""),r["border-style"]?n.find("#borderStyle").value(r["border-style"]):n.find("#borderStyle").value(""),n.find("#style").value(t.serializeStyle(t.parseStyle(t.serializeStyle(r))))}})},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,defaults:{type:"textbox",maxWidth:50,onchange:function(e){G(r,e.control.rootControl)}},items:[{label:"Vertical space",name:"vspace"},{label:"Border width",name:"border"},{label:"Horizontal space",name:"hspace"},{label:"Border style",type:"listbox",name:"borderStyle",width:90,maxWidth:90,onselect:function(e){G(r,e.control.rootControl)},values:[{text:"Select...",value:""},{text:"Solid",value:"solid"},{text:"Dotted",value:"dotted"},{text:"Dashed",value:"dashed"},{text:"Double",value:"double"},{text:"Groove",value:"groove"},{text:"Ridge",value:"ridge"},{text:"Inset",value:"inset"},{text:"Outset",value:"outset"},{text:"None",value:"none"},{text:"Hidden",value:"hidden"}]}]}]}),(g(u)||f(u))&&s.push({title:"Upload",type:"form",layout:"flex",direction:"column",align:"stretch",padding:"20 20 20 20",items:[{type:"container",layout:"flex",direction:"column",align:"center",spacing:10,items:[{text:"Browse for an image",type:"browsebutton",accept:ie,onchange:oe(a=u)},{text:"OR",type:"label"}]},{text:"Drop an image here",type:"dropzone",accept:ie,height:100,onchange:oe(a)}]}),n=u.windowManager.open({title:"Insert/edit image",data:c,bodyType:"tabpanel",body:s,onSubmit:le(ce,u)})}else n=u.windowManager.open({title:"Insert/edit image",data:c,body:te(u,t),onSubmit:le(ce,u)});Q(n)}return{open:function(){var t,e;t=n,"string"==typeof(e=u.getParam("image_list",!1))?o.send({url:e,success:function(e){t(JSON.parse(e))}}):"function"==typeof e?e(t):t(e)}}}var ue=function(o){return function(e){for(var t,n,a=e.length,r=function(e){e.attr("contenteditable",o?"true":null)};a--;)(n=(t=e[a]).attr("class"))&&/\bimage\b/.test(n)&&(t.attr("contenteditable",o?"false":null),y.each(t.getAll("figcaption"),r))}};e.add("image",function(e){var t,n,a;(a=e).on("preInit",function(){a.parser.addNodeFilter("figure",ue(!0)),a.serializer.addNodeFilter("figure",ue(!1))}),(n=e).addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:se(n).open,stateSelector:"img:not([data-mce-object],[data-mce-placeholder]),figure.image"}),n.addMenuItem("image",{icon:"image",text:"Image",onclick:se(n).open,context:"insert",prependToContext:!0}),(t=e).addCommand("mceImage",se(t).open)})}();